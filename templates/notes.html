{% extends "base.html" %}

{% block title %}–ó–∞–º–µ—Ç–∫–∏ - {{ book[0] }}{% endblock %}

{% block content %}
<div class="notes-container">
    <div class="notes-header">
        <h1>üìù –ó–∞–º–µ—Ç–∫–∏</h1>
        <div class="book-info">
            <h2>{{ book[0] }}</h2>
            <p class="author">{{ book[1] }}</p>
        </div>
        <div class="notes-actions">
            <a href="/" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥ –∫ –∫–∞—Ç–∞–ª–æ–≥—É</a>
        </div>
    </div>

    <div class="notes-content">
        {% if notes %}
            <div class="notes-stats">
                <p>–í—Å–µ–≥–æ –∑–∞–º–µ—Ç–æ–∫: <strong>{{ notes|length }}</strong></p>
            </div>

            <div class="notes-list">
                {% for note in notes %}
                <div class="note-item" data-note-id="{{ note[0] }}">
                    <div class="note-header">
                        <span class="chapter-badge">{{ note[1] }}</span>
                        <span class="note-date">{{ note[4] }}</span>
                        <div class="note-actions">
                            <button class="btn-edit" onclick="editNote({{ note[0] }})">‚úèÔ∏è</button>
                            <button class="btn-delete" onclick="deleteNote({{ note[0] }})">üóëÔ∏è</button>
                        </div>
                    </div>
                    
                    <div class="selected-text">
                        <blockquote>{{ note[2] }}</blockquote>
                    </div>
                    
                    {% if note[3] %}
                    <div class="note-text">
                        <p>{{ note[3] }}</p>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="no-notes">
                <div class="empty-state">
                    <h3>–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–º–µ—Ç–æ–∫</h3>
                    <p>–í—ã–¥–µ–ª–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤ –≥–ª–∞–≤–∞—Ö –∫–Ω–∏–≥–∏, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –∑–∞–º–µ—Ç–∫–∏</p>
                    <p>üìö –û—Ç–∫—Ä–æ–π—Ç–µ –ª—é–±—É—é –≥–ª–∞–≤—É –∏ –≤—ã–¥–µ–ª–∏—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç —Ç–µ–∫—Å—Ç–∞</p>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–º–µ—Ç–∫–∏ -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–º–µ—Ç–∫—É</h3>
            <span class="close" onclick="closeEditModal()">&times;</span>
        </div>
        <div class="modal-body">
            <textarea id="editNoteText" placeholder="–î–æ–±–∞–≤—å—Ç–µ —Å–≤–æ–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–º—É —Ç–µ–∫—Å—Ç—É..."></textarea>
        </div>
        <div class="modal-footer">
            <button onclick="closeEditModal()" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
            <button onclick="saveEditedNote()" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>

<script>
let currentEditingNoteId = null;

function editNote(noteId) {
    currentEditingNoteId = noteId;
    const noteItem = document.querySelector(`[data-note-id="${noteId}"]`);
    const noteText = noteItem.querySelector('.note-text p');
    const currentText = noteText ? noteText.textContent : '';
    
    document.getElementById('editNoteText').value = currentText;
    document.getElementById('editModal').style.display = 'block';
}

function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
    currentEditingNoteId = null;
}

function saveEditedNote() {
    if (!currentEditingNoteId) return;
    
    const noteText = document.getElementById('editNoteText').value;
    
    fetch(`/api/notes/${currentEditingNoteId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            note_text: noteText
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∑–∞–º–µ—Ç–∫–∏: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∑–∞–º–µ—Ç–∫–∏');
    });
    
    closeEditModal();
}

function deleteNote(noteId) {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–º–µ—Ç–∫—É?')) {
        return;
    }
    
    fetch(`/api/notes/${noteId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–º–µ—Ç–∫–∏: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–º–µ—Ç–∫–∏');
    });
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
window.onclick = function(event) {
    const modal = document.getElementById('editModal');
    if (event.target == modal) {
        closeEditModal();
    }
}
</script>
{% endblock %}