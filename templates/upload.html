{% extends "base.html" %}

{% block title %}–î–æ–±–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É - EPUB Cutter Web{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="bi bi-upload"></i> –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∫–Ω–∏–≥—É</h1>
    <p class="page-subtitle">–ó–∞–≥—Ä—É–∑–∏—Ç–µ EPUB –∏–ª–∏ PDF —Ñ–∞–π–ª, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –≤–µ–±-—Å–∞–π—Ç –∫–Ω–∏–≥–∏</p>
</div>

<div class="upload-container">
    <div class="upload-zone" id="uploadZone">
        <div class="upload-content">
            <div class="upload-icon">
                <i class="bi bi-cloud-upload"></i>
            </div>
            <h3>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ EPUB –∏–ª–∏ PDF —Ñ–∞–π–ª —Å—é–¥–∞</h3>
            <p>–∏–ª–∏</p>
            <button class="btn btn-primary" id="selectFileBtn">
                <i class="bi bi-folder"></i> –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
            </button>
            <input type="file" id="fileInput" accept=".epub,.pdf" style="display: none;">
            <div class="upload-info">
                <small>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ñ–∞–π–ª—ã .epub –∏ .pdf (–º–∞–∫—Å. 100 –ú–ë)</small>
            </div>
        </div>
    </div>

    <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä -->
    <div class="progress-container" id="progressContainer" style="display: none;">
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-text" id="progressText">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div class="progress-details" id="progressDetails" style="margin-top: 10px; font-size: 0.9rem; color: var(--secondary-color);"></div>
    </div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç -->
    <div class="result-container" id="resultContainer" style="display: none;">
        <div class="result-success" id="resultSuccess">
            <i class="bi bi-check-circle"></i>
            <h3>–ö–Ω–∏–≥–∞ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞!</h3>
            <div class="result-book-info" id="resultBookInfo"></div>
            <div class="result-actions">
                <button class="btn btn-primary" id="viewBookBtn">
                    <i class="bi bi-eye"></i> –û—Ç–∫—Ä—ã—Ç—å –∫–Ω–∏–≥—É
                </button>
                <a href="{{ url_for('index') }}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫—É
                </a>
            </div>
        </div>
        <div class="result-error" id="resultError">
            <i class="bi bi-exclamation-circle"></i>
            <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h3>
            <p id="errorMessage"></p>
            <button class="btn btn-primary" onclick="resetUpload()">
                <i class="bi bi-arrow-clockwise"></i> –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const uploadZone = document.getElementById('uploadZone');
const fileInput = document.getElementById('fileInput');
const selectFileBtn = document.getElementById('selectFileBtn');
const progressContainer = document.getElementById('progressContainer');
const progressFill = document.getElementById('progressFill');
const progressText = document.getElementById('progressText');
const progressDetails = document.getElementById('progressDetails');
const resultContainer = document.getElementById('resultContainer');
const resultSuccess = document.getElementById('resultSuccess');
const resultError = document.getElementById('resultError');
const errorMessage = document.getElementById('errorMessage');
const resultBookInfo = document.getElementById('resultBookInfo');
const viewBookBtn = document.getElementById('viewBookBtn');

let currentBookPath = null;

// –û–±—Ä–∞–±–æ—Ç–∫–∞ drag & drop
uploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadZone.classList.add('drag-over');
});

uploadZone.addEventListener('dragleave', (e) => {
    e.preventDefault();
    uploadZone.classList.remove('drag-over');
});

uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.classList.remove('drag-over');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleFile(files[0]);
    }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
selectFileBtn.addEventListener('click', () => {
    fileInput.click();
});

fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        handleFile(e.target.files[0]);
    }
});

function handleFile(file) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞
    const fileName = file.name.toLowerCase();
    if (!fileName.endsWith('.epub') && !fileName.endsWith('.pdf')) {
        showError('–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è EPUB –∏ PDF.');
        return;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (100 –ú–ë)
    if (file.size > 100 * 1024 * 1024) {
        showError('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 100 –ú–ë.');
        return;
    }

    uploadFile(file);
}

function uploadFile(file) {
    const formData = new FormData();
    formData.append('file', file);

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
    uploadZone.style.display = 'none';
    progressContainer.style.display = 'block';
    resultContainer.style.display = 'none';
    
    progressFill.style.width = '10%';
    progressText.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞...';
    progressDetails.textContent = `–§–∞–π–ª: ${file.name}`;

    // –°–æ–∑–¥–∞–µ–º XMLHttpRequest –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∑–∞–≥—Ä—É–∑–∫–∏
    const xhr = new XMLHttpRequest();
    
    xhr.upload.addEventListener('progress', (e) => {
        if (e.lengthComputable) {
            const percentComplete = (e.loaded / e.total) * 50; // –ó–∞–≥—Ä—É–∑–∫–∞ - –ø–µ—Ä–≤—ã–µ 50%
            progressFill.style.width = Math.max(10, percentComplete) + '%';
            progressText.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞... ${Math.round(percentComplete * 2)}%`;
        }
    });

    xhr.addEventListener('load', () => {
        if (xhr.status === 200) {
            try {
                const response = JSON.parse(xhr.responseText);
                if (response.success) {
                    // –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω
                    progressFill.style.width = '100%';
                    progressText.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!';
                    setTimeout(() => {
                        showSuccess(response);
                    }, 500);
                } else {
                    showError(response.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                }
            } catch (e) {
                showError('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞');
            }
        } else {
            showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä');
        }
    });

    xhr.addEventListener('error', () => {
        showError('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞');
    });

    xhr.open('POST', '/upload');
    xhr.send(formData);
}


function showSuccess(data) {
    progressContainer.style.display = 'none';
    resultContainer.style.display = 'block';
    resultSuccess.style.display = 'block';
    resultError.style.display = 'none';

    // –ó–∞–ø–æ–ª–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–Ω–∏–≥–µ
    const fileTypeIcon = 'üìñ'; // EPUB —Ñ–∞–π–ª
    const chaptersLabel = '–≥–ª–∞–≤';
    
    resultBookInfo.innerHTML = `
        <div class="book-preview">
            <h4>${fileTypeIcon} ${data.title}</h4>
            <p><strong>–ê–≤—Ç–æ—Ä:</strong> ${data.author}</p>
            <p><strong>–¢–∏–ø —Ñ–∞–π–ª–∞:</strong> EPUB</p>
            <p><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ ${chaptersLabel}:</strong> ${data.chapters_count}</p>
        </div>
    `;

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –∫–Ω–∏–≥—É
    currentBookPath = data.site_path;
    viewBookBtn.onclick = () => {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å –∫–∞–∫ –æ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
        window.open(`/book/${currentBookPath}/index.html`, '_blank');
    };
}

function showError(message) {
    progressContainer.style.display = 'none';
    resultContainer.style.display = 'block';
    resultSuccess.style.display = 'none';
    resultError.style.display = 'block';
    errorMessage.textContent = message;
}

function resetUpload() {
    uploadZone.style.display = 'block';
    progressContainer.style.display = 'none';
    resultContainer.style.display = 'none';
    fileInput.value = '';
    progressFill.style.width = '0%';
    progressText.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
    progressDetails.textContent = '';
    currentBookPath = null;
}
</script>
{% endblock %}